<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.23">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Susan Eileen Fox">
<meta name="dcterms.date" content="2025-09-28">

<title>Chapter 3, Webcams and Videos – Vision Readings</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-226bd0f977fa82dfae4534cac220d79a.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-9011e249e8d359b0658fa71d60c1fa6f.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Vision Readings</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Chapter 3, Webcams and Videos</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Susan Eileen Fox </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">September 28, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#indefinite-looping" id="toc-indefinite-looping" class="nav-link active" data-scroll-target="#indefinite-looping"><span class="header-section-number">1</span> Indefinite looping</a>
  <ul class="collapse">
  <li><a href="#what-is-a-while-loop-and-why-do-we-need-another-kind-of-loop" id="toc-what-is-a-while-loop-and-why-do-we-need-another-kind-of-loop" class="nav-link" data-scroll-target="#what-is-a-while-loop-and-why-do-we-need-another-kind-of-loop"><span class="header-section-number">1.1</span> What is a while loop, and why do we need another kind of loop?</a></li>
  <li><a href="#the-break-and-continue-statements" id="toc-the-break-and-continue-statements" class="nav-link" data-scroll-target="#the-break-and-continue-statements"><span class="header-section-number">1.2</span> The break and continue statements</a>
  <ul class="collapse">
  <li><a href="#strategic-use-of-infinite-loops" id="toc-strategic-use-of-infinite-loops" class="nav-link" data-scroll-target="#strategic-use-of-infinite-loops"><span class="header-section-number">1.2.1</span> Strategic use of infinite loops</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#connecting-to-a-built-in-webcam" id="toc-connecting-to-a-built-in-webcam" class="nav-link" data-scroll-target="#connecting-to-a-built-in-webcam"><span class="header-section-number">2</span> Connecting to a built-in webcam</a>
  <ul class="collapse">
  <li><a href="#allow-the-user-to-quit-the-program" id="toc-allow-the-user-to-quit-the-program" class="nav-link" data-scroll-target="#allow-the-user-to-quit-the-program"><span class="header-section-number">2.1</span> Allow the user to quit the program</a></li>
  </ul></li>
  <li><a href="#reading-frames-from-a-video-file" id="toc-reading-frames-from-a-video-file" class="nav-link" data-scroll-target="#reading-frames-from-a-video-file"><span class="header-section-number">3</span> Reading frames from a video file</a></li>
  <li><a href="#saving-a-webcam-stream-to-a-video-file" id="toc-saving-a-webcam-stream-to-a-video-file" class="nav-link" data-scroll-target="#saving-a-webcam-stream-to-a-video-file"><span class="header-section-number">4</span> Saving a webcam stream to a video file</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>This chapter will introduce two main new concepts, one from Python and one from OpenCV. The Python concepts is indefinite looping (also called <code>while</code> loops). Unlike a <code>for</code> loop, which repeats a fixed number of times, <code>while</code> loops repeat until some condition changes. They can repeat any number of times, including zero times! The OpenCV concept is working with video. You might think of video as a completely different medium from regular still images, but to OpenCV, a video is just a series of images, and we can process them one by one.</p>
<p>This chapter will just touch on <code>while</code> loops, as there are readings elsewhere that will also cover them.</p>
<section id="indefinite-looping" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Indefinite looping</h1>
<p>The <code>for</code> loop you learned earlier is an example of <strong>definite looping</strong>, because the number of iterations is defined by the size of the data it loops over (or built in to the result of the <code>range</code> function). We can shorten a <code>for</code> loop by breaking out of it early, but it is difficult (though at times not impossible) to make a <code>for</code> loop iterate more times than it might initially have seemed.</p>
<p>There are circumstances when we don’t know exactly how many times we need to repeat: getting data in a stream, reading inputs interactively from a user, repeating a calculation until its value hits some threshold. For those, we need an <strong>indefinite loop</strong>: one where the loop continues until some condition either is reached, or ceases to apply. For example, in getting inputs from a user, we want to loop until the user decides they are done adding values. The <code>while</code> loop is Python’s form for indefinite looping.</p>
<section id="what-is-a-while-loop-and-why-do-we-need-another-kind-of-loop" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="what-is-a-while-loop-and-why-do-we-need-another-kind-of-loop"><span class="header-section-number">1.1</span> What is a while loop, and why do we need another kind of loop?</h2>
<p>A <code>while</code> loop has a simpler structure than a <code>for</code> loop (in fact, you can duplicate the behavior of a <code>for</code> loop with a <code>while</code> loop, using accumulator variables. After the keyword <code>while</code>, we put a boolean expression. So long as that boolean expression evaluates to <code>True</code> (or any non-<code>False</code> value), the loop will continue.</p>
<div id="637fee87" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="cf">while</span> <span class="op">&lt;</span>boolean expression<span class="op">&gt;</span>:</span>
<span id="cb1-2"><a href="#cb1-2"></a>    <span class="op">&lt;</span>indented statements<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Before each pass through the loop, the <code>while</code> statement evaluates the boolean expression over again. If the result is not <code>True</code> then the code stops looping and jumps to the next statement after the indented lines of the loop body. If the result <strong>is</strong> <code>True</code>, then the body of the loop is executed, and we repeat the process.</p>
<p><strong>Note:</strong> If we want a <code>while</code> loop to be able to end, then the boolean expression must include a variable whose value changes (or at least has the possibility of changing) during the</p>
<p><strong>What is the difference between an <code>if</code> statement and a <code>while</code> statement?</strong></p>
<p>An <code>if</code> statement doesn’t repeat, it chooses among possible multiple code blocks, and performs one code block at most one time. A <code>while</code> loop repeats: it has one code block, and it repeats (1) evaluating the test expression, and (2) performing its code block, until the test expressions evaluates to <code>False</code>.</p>
</section>
<section id="the-break-and-continue-statements" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="the-break-and-continue-statements"><span class="header-section-number">1.2</span> The break and continue statements</h2>
<p>There are two statements, <code>break</code> and <code>continue</code> that can alter the behavior of a loop. These apply to both <code>for</code> loops and <code>while</code> loops; we just haven’t introduced them before this point.</p>
<p><strong>Key points:</strong></p>
<ul>
<li>Both statements must occur inside a <code>for</code> or <code>while</code> loop (directly inside, in the same script or function)</li>
<li>If there are nested loops, these statements only affect the closest, innermost loop that contains them</li>
<li>The <code>break</code> statement causes the loop to end immediately</li>
<li>The <code>continue</code> statement causes Python to skip the rest of the loop body, and return to the next iteration of the loop</li>
<li>Usually, <code>break</code> and <code>continue</code> statements occur inside an <code>if</code> statement that is inside the loop body (otherwise the loop would end on the first iteration)</li>
</ul>
<p>Examine the examples below before proceeding.</p>
<p><strong>Bad uses of <code>break</code> and <code>continue</code>:</strong> the examples below show what happens if <code>break</code> or <code>continue</code> are placed, without being <em>guarded</em> by an <code>if</code> statement, inside a loop.</p>
<div id="31d1b354" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb2-2"><a href="#cb2-2"></a>    <span class="bu">print</span>(i, <span class="st">"   (before break)"</span>)</span>
<span id="cb2-3"><a href="#cb2-3"></a>    <span class="cf">break</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>    <span class="bu">print</span>(<span class="st">"after break"</span>)</span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="bu">print</span>(<span class="st">"---"</span>)</span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb2-7"><a href="#cb2-7"></a>    <span class="bu">print</span>(i, <span class="st">"   (before continue)"</span>)</span>
<span id="cb2-8"><a href="#cb2-8"></a>    <span class="cf">continue</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>    <span class="bu">print</span>(<span class="st">"after contine"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0    (before break)
---
0    (before continue)
1    (before continue)
2    (before continue)
3    (before continue)
4    (before continue)</code></pre>
</div>
</div>
<p><strong>Using <code>break</code> and <code>continue</code> in a single loop:</strong> The first example stops the <code>while</code> loop if the user enters <code>'quit'</code>, and the second example skips negative numbers in adding up the contents of a list.</p>
<div id="e8f07a41" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a>names <span class="op">=</span> []</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="cf">while</span> <span class="va">True</span>:   <span class="co"># A way to specify "loop forever"</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>    nextName <span class="op">=</span> <span class="bu">input</span>(<span class="st">"Enter the next name, or quit to end: "</span>)</span>
<span id="cb4-4"><a href="#cb4-4"></a>    <span class="cf">if</span> nextName <span class="op">==</span> <span class="st">'quit'</span>:</span>
<span id="cb4-5"><a href="#cb4-5"></a>        <span class="cf">break</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>    names.append(nextName)</span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="bu">print</span>(names)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="46cb7373" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a>total <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="cf">for</span> v <span class="kw">in</span> [<span class="dv">25</span>, <span class="dv">101</span>, <span class="dv">3</span>, <span class="op">-</span><span class="dv">2</span>, <span class="dv">40</span>, <span class="op">-</span><span class="dv">35</span>, <span class="op">-</span><span class="dv">1023</span>]:</span>
<span id="cb5-3"><a href="#cb5-3"></a>    <span class="cf">if</span> v <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb5-4"><a href="#cb5-4"></a>        <span class="cf">continue</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>    total <span class="op">=</span> total <span class="op">+</span> v</span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="bu">print</span>(total)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>169</code></pre>
</div>
</div>
<p>**Using <code>break</code> and <code>continue</code> in nested loops: The first example uses <code>break</code> to stop the inner loop whenever the inner loop variable is greater than the outer loop variable.</p>
<div id="3ee46828" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">4</span>):</span>
<span id="cb7-2"><a href="#cb7-2"></a>    <span class="bu">print</span>(<span class="st">"i ="</span>, i)</span>
<span id="cb7-3"><a href="#cb7-3"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">4</span>):</span>
<span id="cb7-4"><a href="#cb7-4"></a>        <span class="bu">print</span>(<span class="st">"  j ="</span>, j)</span>
<span id="cb7-5"><a href="#cb7-5"></a>        <span class="cf">if</span> j <span class="op">&gt;</span> i:</span>
<span id="cb7-6"><a href="#cb7-6"></a>            <span class="cf">break</span></span>
<span id="cb7-7"><a href="#cb7-7"></a>        <span class="bu">print</span>(<span class="st">"  i - j ="</span>, i <span class="op">-</span> j)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>i = 0
  j = 0
  i - j = 0
  j = 1
i = 1
  j = 0
  i - j = 1
  j = 1
  i - j = 0
  j = 2
i = 2
  j = 0
  i - j = 2
  j = 1
  i - j = 1
  j = 2
  i - j = 0
  j = 3
i = 3
  j = 0
  i - j = 3
  j = 1
  i - j = 2
  j = 2
  i - j = 1
  j = 3
  i - j = 0</code></pre>
</div>
</div>
<p>The second example uses <code>continue</code> instead, causing the inner loop to continue, without completing the last step.</p>
<div id="0e6ae2b0" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">4</span>):</span>
<span id="cb9-2"><a href="#cb9-2"></a>    <span class="bu">print</span>(<span class="st">"i ="</span>, i)</span>
<span id="cb9-3"><a href="#cb9-3"></a>    <span class="cf">for</span> j <span class="kw">in</span> [<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">3</span>]:</span>
<span id="cb9-4"><a href="#cb9-4"></a>        <span class="bu">print</span>(<span class="st">"  j ="</span>, j)</span>
<span id="cb9-5"><a href="#cb9-5"></a>        <span class="cf">if</span> j <span class="op">&gt;</span> i:</span>
<span id="cb9-6"><a href="#cb9-6"></a>            <span class="cf">continue</span></span>
<span id="cb9-7"><a href="#cb9-7"></a>        <span class="bu">print</span>(<span class="st">"  i - j ="</span>, i <span class="op">-</span> j)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>i = 0
  j = 2
  j = 0
  i - j = 0
  j = 1
  j = 3
i = 1
  j = 2
  j = 0
  i - j = 1
  j = 1
  i - j = 0
  j = 3
i = 2
  j = 2
  i - j = 0
  j = 0
  i - j = 2
  j = 1
  i - j = 1
  j = 3
i = 3
  j = 2
  i - j = 1
  j = 0
  i - j = 3
  j = 1
  i - j = 2
  j = 3
  i - j = 0</code></pre>
</div>
</div>
<section id="strategic-use-of-infinite-loops" class="level3" data-number="1.2.1">
<h3 data-number="1.2.1" class="anchored" data-anchor-id="strategic-use-of-infinite-loops"><span class="header-section-number">1.2.1</span> Strategic use of infinite loops</h3>
<p>One of the examples above showed how to build an <strong>infinite loop</strong>. If a <code>while</code> loop has <code>True</code> as the boolean expression for its test, then it cannot every stop looping naturally. However, we can include conditions checked by <code>if</code> statements inside the loop, and we can break out of the loop when we need to.</p>
<div id="d1fd26e2" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb11-2"><a href="#cb11-2"></a>    ...</span>
<span id="cb11-3"><a href="#cb11-3"></a>    <span class="cf">if</span> <span class="op">&lt;</span>test<span class="op">&gt;</span>:</span>
<span id="cb11-4"><a href="#cb11-4"></a>        <span class="cf">break</span></span>
<span id="cb11-5"><a href="#cb11-5"></a>    ...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Remember that the test of a <code>while</code> loop is evaluated before running the loop even one time. This means that (1) we have to have all values for the boolean expression ready to evaluate before the loop, and (2) there is a chance that the loop body will not even execute one time. The infinite loop form above (<code>while True</code>) ensures that the body of the loop will execute at least once, allowing us to delay the evaluation of the test condition until later inside the loop.</p>
</section>
</section>
</section>
<section id="connecting-to-a-built-in-webcam" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Connecting to a built-in webcam</h1>
<p>Working with frames from a video instead of individual iamges opens up a new set of interesting problems, and lets us dynamically test the computer vision methods we study. OpenCV can connect directly to the built-in webcams that most laptops have, or to external USB cameras, or to video files stored in the AVI format.</p>
<p><strong>If you do not have a working webcam,</strong> ask your instructor for help!</p>
<p>To connect to a video camera or stored video file, we will create a <strong>video capture</strong> object. This object handles the communications with the operating system to access the camera or file. It has methods that let us read the frames of the video stream, and to read or adjust some of the camera’s properties. The table below lists the main functions and methods you will need.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 31%">
<col style="width: 69%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Examples</th>
<th style="text-align: left;">Meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>cap = cv2.VideoCapture(0)</code></td>
<td style="text-align: left;">Creates a VideoCapture object connected to specified camera</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>cap.isOpened()</code></td>
<td style="text-align: left;">Boolean method returns true if camera connection succeeded</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>ret, image = cap.read()</code></td>
<td style="text-align: left;">Method returns two values, a code to tell if the image was read successfully, and an image from the video stream</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>cap.release()</code></td>
<td style="text-align: left;">Method disconnects from camera</td>
</tr>
</tbody>
</table>
<p>The <code>VideoCapture</code> function constructs and returns a video capture object. It takes one required input: a number, to connect to a webcam on the computer, or a path and filename for an AVI video file. A built-in webcam typically has number zero, but the number assigned to an external webcams depends on the internal hardware connections. You may need to experiment to figure out the right number.</p>
<p>The main method we will use is <code>read</code>, which reads one frame from the camera. There are two return values for this method. The first is a boolean, <code>True</code> if the frame was read without issues, and <code>False</code> if it failed to read a frame. We can check this to determine if we have an actual image, before trying to work with it. The second returned value is the image itself, or <code>None</code> if no frame was read.</p>
<p>The script below shows a basic program that will connect to a built-in camera, and read and display frames until the program can’t access the camera. Notice the following changes from earlier programs:</p>
<ul>
<li>We use the infinite, indefinite loop form</li>
<li>We use the <code>not ret</code> boolean expression to determine if no camera frame was read, and we break out of the loop if none</li>
<li>Our call to <code>waitKey</code> here has an input, a positive number!</li>
</ul>
<div id="ae0ebfb8" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1"></a><span class="im">import</span> cv2</span>
<span id="cb12-2"><a href="#cb12-2"></a></span>
<span id="cb12-3"><a href="#cb12-3"></a>vidCap <span class="op">=</span> cv2.VideoCapture(<span class="dv">0</span>)</span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb12-5"><a href="#cb12-5"></a>    ret, img <span class="op">=</span> vidCap.read()</span>
<span id="cb12-6"><a href="#cb12-6"></a>    <span class="cf">if</span> <span class="kw">not</span> ret:</span>
<span id="cb12-7"><a href="#cb12-7"></a>        <span class="cf">break</span></span>
<span id="cb12-8"><a href="#cb12-8"></a>    cv2.imshow(<span class="st">"Webcam"</span>, img)</span>
<span id="cb12-9"><a href="#cb12-9"></a>    cv2.waitKey(<span class="dv">10</span>)</span>
<span id="cb12-10"><a href="#cb12-10"></a></span>
<span id="cb12-11"><a href="#cb12-11"></a>vidCap.release()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It is time to learn more about what <code>waitKey</code> can do. We already have seen that if we call <code>waitKey</code> and pass it no input, or an input of zero, the function pauses the program until the user types a keyboard key. <strong>Now,</strong> we learn that we can pass a positive integer to <code>waitKey</code>. When we do that, the function pauses for the given number of <strong>milliseconds</strong> to see if the user will press a key. If they do not press a key in that time, then the function returns and the program resumes. This way, we can show a video stream in a natural way.</p>
<p><strong>Try this program on your own before proceeding.</strong></p>
<section id="allow-the-user-to-quit-the-program" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="allow-the-user-to-quit-the-program"><span class="header-section-number">2.1</span> Allow the user to quit the program</h2>
<p>The sample program in the previous section had one major flaw: there was no way to quit the program without using the Stop button in Pycharm. Otherwise, the program would run until the camera itself disconnected. We would like to add a mechanism for the user to quit the program, and also for us to interact with programs like this while they are running. We can do this by using the <em>return value</em> of the <code>waitKey</code> function.</p>
<p>We have ignored the return value of <code>waitKey</code> up to this point. But it does return a value, one of these two:</p>
<ul>
<li>It returns -1 if the user pressed no key</li>
<li>It returns a number representing the keyboard key pressed by the user</li>
</ul>
<p>Remember <a href="https://www.ascii-code.com/">the ASCII table</a>, which maps small integers to keyboard characters. The original ASCII values, developed for English uses, used the numbers from 0 to 127. The <em>extended</em> ASCII set adding character bindings for the numbers from 128 to 255, including many more common international symbols that use the same general alphabet. In recent years, Unicode has become popular, as it has the capacity to represent multiple alphabets, but the basic English/roman alphabet symbols, as defined by the ASCII table, are still the same in Unicode.</p>
<p>The <code>waitKey</code> function returns the <strong>decimal</strong> integer associated with the key the user hit (or -1 if no key was pressed). Look at the Dec column in the table. We need to be able to convert that number into the corresponding character. Python provides two helpful functions for just this purpose: <code>chr</code> converts an integer between 0 and 255 into the character equivalent, and <code>ord</code> converts a character into its integer equivalent.</p>
<p>The example program below adds in lines that:</p>
<ul>
<li>Save the return value of <code>waitKey</code> into a variable</li>
<li>Check if that variable was -1 (in which case it does nothing)</li>
<li>If not, then it converts the value to a character with <code>chr</code></li>
<li>It prints the character value, along with its numeric value</li>
<li>If the user typed a <code>'q'</code>, then it breaks out of the loop</li>
</ul>
<div id="109b49e2" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a><span class="im">import</span> cv2</span>
<span id="cb13-2"><a href="#cb13-2"></a></span>
<span id="cb13-3"><a href="#cb13-3"></a>cap <span class="op">=</span> cv2.VideoCapture(<span class="dv">0</span>)</span>
<span id="cb13-4"><a href="#cb13-4"></a></span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb13-6"><a href="#cb13-6"></a>    ret, img <span class="op">=</span> cap.read()</span>
<span id="cb13-7"><a href="#cb13-7"></a>    <span class="cf">if</span> <span class="kw">not</span> ret:</span>
<span id="cb13-8"><a href="#cb13-8"></a>        <span class="cf">break</span></span>
<span id="cb13-9"><a href="#cb13-9"></a>        </span>
<span id="cb13-10"><a href="#cb13-10"></a>    cv2.imshow(<span class="st">"Webcam"</span>, img)</span>
<span id="cb13-11"><a href="#cb13-11"></a>    x <span class="op">=</span> cv2.waitKey(<span class="dv">10</span>)</span>
<span id="cb13-12"><a href="#cb13-12"></a>    <span class="cf">if</span> x <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span>:</span>
<span id="cb13-13"><a href="#cb13-13"></a>        ch <span class="op">=</span> <span class="bu">chr</span>(x)</span>
<span id="cb13-14"><a href="#cb13-14"></a>        <span class="bu">print</span>(x, <span class="bu">chr</span>(x))</span>
<span id="cb13-15"><a href="#cb13-15"></a>        <span class="cf">if</span> ch <span class="op">==</span> <span class="st">'q'</span>:</span>
<span id="cb13-16"><a href="#cb13-16"></a>            <span class="cf">break</span></span>
<span id="cb13-17"><a href="#cb13-17"></a></span>
<span id="cb13-18"><a href="#cb13-18"></a>cap.release()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="reading-frames-from-a-video-file" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Reading frames from a video file</h1>
<p>There are multiple formats for video files. Only some of them can be read by OpenCV, and which ones may be dependent on your version of Python and your operating system. Most videos in .AVI format (an MJPEG format) work with OpenCV, as do .MP4 files, at least on some machines. OpenCV does not process the audio from these video files, just the images.</p>
<p>To read frames from a video file, we just change the call to <code>VideoCapture</code> to pass a string containing the path and filename of the video we want to view. Below is a simple example using one of the videos in the <code>SampleVideos</code> folder.</p>
<div id="26c62ded" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1"></a><span class="im">import</span> cv2</span>
<span id="cb14-2"><a href="#cb14-2"></a></span>
<span id="cb14-3"><a href="#cb14-3"></a>cap <span class="op">=</span> cv2.VideoCapture(<span class="st">"SampleVideos/StreetScene.avi"</span>)</span>
<span id="cb14-4"><a href="#cb14-4"></a></span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb14-6"><a href="#cb14-6"></a>    ret, img <span class="op">=</span> cap.read()</span>
<span id="cb14-7"><a href="#cb14-7"></a>    <span class="cf">if</span> <span class="kw">not</span> ret:</span>
<span id="cb14-8"><a href="#cb14-8"></a>        <span class="cf">break</span></span>
<span id="cb14-9"><a href="#cb14-9"></a>        </span>
<span id="cb14-10"><a href="#cb14-10"></a>    cv2.imshow(<span class="st">"Video"</span>, img)</span>
<span id="cb14-11"><a href="#cb14-11"></a>    x <span class="op">=</span> cv2.waitKey(<span class="dv">10</span>)</span>
<span id="cb14-12"><a href="#cb14-12"></a>    <span class="cf">if</span> x <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span>:</span>
<span id="cb14-13"><a href="#cb14-13"></a>        ch <span class="op">=</span> <span class="bu">chr</span>(x)</span>
<span id="cb14-14"><a href="#cb14-14"></a>        <span class="bu">print</span>(x, <span class="bu">chr</span>(x))</span>
<span id="cb14-15"><a href="#cb14-15"></a>        <span class="cf">if</span> ch <span class="op">==</span> <span class="st">'q'</span>:</span>
<span id="cb14-16"><a href="#cb14-16"></a>            <span class="cf">break</span></span>
<span id="cb14-17"><a href="#cb14-17"></a></span>
<span id="cb14-18"><a href="#cb14-18"></a>cap.release()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice that, other than setting up the <code>VideoCapture</code> object, this code is identical to the code for working with a live web-cam feed. This is very convenient for us!</p>
</section>
<section id="saving-a-webcam-stream-to-a-video-file" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Saving a webcam stream to a video file</h1>
<p>Writing a stream of images to a video file is much more complicated than reading a video, or than writing individual images. The <code>VideoWriter</code> object can write frames to a video file. We must know, before we start, how big we want the individual frames to be, and what <em>encoding</em> we want to use. For the <code>.avi</code> format, we use the MJPG encoding.</p>
<dl>
<dt>Build Encoding:</dt>
<dd>
<code>fcc = cv2.VideoWriter_fourcc('M', 'J', 'P', 'G')</code>
</dd>
</dl>
<p>Takes in 4 characters that describe the encoding and returns the encoding code to use in creating the <code>VideoWriter</code></p>
<dl>
<dt>Build writer object:</dt>
<dd>
<code>writ = cv2.VideoWriter('vid.avi', fcc, 40.0, (w, h))</code>
</dd>
</dl>
<p>Builds a video writer object based on four required inputs:</p>
<ul>
<li>the filename to save to (including <code>.avi</code> file extension),</li>
<li>the fourcc encoding object,</li>
<li>the frames per second, and</li>
<li>the size of each frame</li>
</ul>
<dl>
<dt>Write data:</dt>
<dd>
<code>writ.write(frame)</code>
</dd>
</dl>
<p>Method writes the given image as the next frame in the video file</p>
<dl>
<dt>Close writer:</dt>
<dd>
<code>writ.release()</code>
</dd>
</dl>
<p>Method closes the video file and ends the video writer</p>
<p>In the code below, we first:</p>
<ul>
<li>Set up the web-cam and read a frame, to find out what size it is</li>
<li>Set up the encoding for the <code>VideoWriter</code> to be MJPG using a special function <code>VideoWriter_fourcc</code></li>
<li>Create a <code>VideoWriter</code> object with a specified filename, encoding, and size</li>
<li>Loop over frames from the web-cam until the user says to quit, or the camera stops producing frames</li>
<li>Write each frame to the VideoWriter` object, and display it</li>
<li>After the loop ends, we release both camera and video writer objects (very important step!)</li>
</ul>
<div id="1b2c7dc3" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1"></a>cap <span class="op">=</span> cv2.VideoCapture(<span class="dv">0</span>)</span>
<span id="cb15-2"><a href="#cb15-2"></a></span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="co"># First determine the size of frames</span></span>
<span id="cb15-4"><a href="#cb15-4"></a>r, f <span class="op">=</span> cap.read()</span>
<span id="cb15-5"><a href="#cb15-5"></a>cv2.imshow(<span class="st">"Video"</span>, f)</span>
<span id="cb15-6"><a href="#cb15-6"></a>cv2.waitKey(<span class="dv">0</span>)</span>
<span id="cb15-7"><a href="#cb15-7"></a>(hgt, wid, dep) <span class="op">=</span> f.shape</span>
<span id="cb15-8"><a href="#cb15-8"></a>size <span class="op">=</span> (wid, hgt)</span>
<span id="cb15-9"><a href="#cb15-9"></a><span class="bu">print</span>(<span class="st">"Sizes:"</span>, size)</span>
<span id="cb15-10"><a href="#cb15-10"></a></span>
<span id="cb15-11"><a href="#cb15-11"></a><span class="co"># Next set up the video writer</span></span>
<span id="cb15-12"><a href="#cb15-12"></a>filename <span class="op">=</span> <span class="st">"test.avi"</span></span>
<span id="cb15-13"><a href="#cb15-13"></a>fourcc <span class="op">=</span> cv2.VideoWriter_fourcc(<span class="st">'M'</span>, <span class="st">'J'</span>, <span class="st">'P'</span>, <span class="st">'G'</span>)</span>
<span id="cb15-14"><a href="#cb15-14"></a>writ <span class="op">=</span> cv2.VideoWriter(filename, fourcc, <span class="fl">25.0</span>, size, <span class="dv">1</span>)</span>
<span id="cb15-15"><a href="#cb15-15"></a></span>
<span id="cb15-16"><a href="#cb15-16"></a><span class="cf">while</span> cap.isOpened():</span>
<span id="cb15-17"><a href="#cb15-17"></a>    r, f<span class="op">=</span> cap.read()</span>
<span id="cb15-18"><a href="#cb15-18"></a>    <span class="cf">if</span> <span class="kw">not</span> r:</span>
<span id="cb15-19"><a href="#cb15-19"></a>        <span class="cf">break</span></span>
<span id="cb15-20"><a href="#cb15-20"></a>    writ.write(f)</span>
<span id="cb15-21"><a href="#cb15-21"></a>    cv2.imshow(<span class="st">"Video"</span>, f)</span>
<span id="cb15-22"><a href="#cb15-22"></a>    x <span class="op">=</span> cv2.waitKey(<span class="dv">1</span>)</span>
<span id="cb15-23"><a href="#cb15-23"></a>    <span class="cf">if</span> x <span class="op">&gt;=</span> <span class="dv">0</span> <span class="kw">and</span> <span class="bu">chr</span>(x) <span class="op">==</span> <span class="st">'q'</span>:</span>
<span id="cb15-24"><a href="#cb15-24"></a>        <span class="cf">break</span></span>
<span id="cb15-25"><a href="#cb15-25"></a></span>
<span id="cb15-26"><a href="#cb15-26"></a>cap.release()</span>
<span id="cb15-27"><a href="#cb15-27"></a>writ.release()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice that we could process the webcam stream of images any way we like: changing its size, or running image processing or computer vision functions on it. We can write the modified images to our video file. Just remember that the <code>VideoWriter</code> expects BGR images, and will treat the image array as if it were BGR, no matter what.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
        for (let i=0; i<annoteTargets.length; i++) {
          const annoteTarget = annoteTargets[i];
          const targetCell = annoteTarget.getAttribute("data-target-cell");
          const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
          const contentFn = () => {
            const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
            if (content) {
              const tipContent = content.cloneNode(true);
              tipContent.classList.add("code-annotation-tip-content");
              return tipContent.outerHTML;
            }
          }
          const config = {
            allowHTML: true,
            content: contentFn,
            onShow: (instance) => {
              selectCodeLines(instance.reference);
              instance.reference.classList.add('code-annotation-active');
              window.tippy.hideAll();
            },
            onHide: (instance) => {
              unselectCodeLines();
              instance.reference.classList.remove('code-annotation-active');
            },
            maxWidth: 300,
            delay: [50, 0],
            duration: [200, 0],
            offset: [5, 10],
            arrow: true,
            appendTo: function(el) {
              return el.parentElement.parentElement.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'quarto',
            placement: 'right',
            popperOptions: {
              modifiers: [
              {
                name: 'flip',
                options: {
                  flipVariations: false, // true by default
                  allowedAutoPlacements: ['right'],
                  fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
                },
              },
              {
                name: 'preventOverflow',
                options: {
                  mainAxis: false,
                  altAxis: false
                }
              }
              ]        
            }      
          };
          window.tippy(annoteTarget, config); 
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>